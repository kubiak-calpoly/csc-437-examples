(function(r,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(r=typeof globalThis<"u"?globalThis:r||self,c(r.mu={}))})(this,function(r){"use strict";class c extends Error{}c.prototype.name="InvalidTokenError";function b(n){return decodeURIComponent(atob(n).replace(/(.)/g,(e,t)=>{let o=t.charCodeAt(0).toString(16).toUpperCase();return o.length<2&&(o="0"+o),"%"+o}))}function T(n){let e=n.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return b(e)}catch{return atob(e)}}function x(n,e){if(typeof n!="string")throw new c("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,o=n.split(".")[t];if(typeof o!="string")throw new c(`Invalid token specified: missing part #${t+1}`);let s;try{s=T(o)}catch(i){throw new c(`Invalid token specified: invalid base64 for part #${t+1} (${i.message})`)}try{return JSON.parse(s)}catch(i){throw new c(`Invalid token specified: invalid json for part #${t+1} (${i.message})`)}}const d="mu:context:change";class S{constructor(e,t){this._proxy=C(e,t)}get value(){return this._proxy}set value(e){Object.assign(this._proxy,e)}apply(e){this.value=e(this.value)}}class _ extends HTMLElement{constructor(e){super(),console.log("Constructing context",this),this.context=new S(e,this)}attach(e){return this.addEventListener(d,e),e}detach(e){this.removeEventListener(d,e)}}function C(n,e){return console.log("creating Context:",JSON.stringify(n)),new Proxy(n,{get:(o,s,i)=>{if(s==="then")return;const h=Reflect.get(o,s,i);return console.log(`Context['${s}'] => ${JSON.stringify(h)}`),h},set:(o,s,i,h)=>{const E=n[s];console.log(`Context['${s.toString()}'] <= ${JSON.stringify(i)}; was ${JSON.stringify(E)}`);const y=Reflect.set(o,s,i,h);if(y){let f=new CustomEvent(d,{bubbles:!0,cancelable:!0,composed:!0});Object.assign(f,{property:s,oldValue:E,value:i}),e.dispatchEvent(f),console.log("dispatched event to target",f,e)}else console.log(`Context['${s}] was not set to ${i}`);return y}})}class N extends CustomEvent{constructor(e,t="mu:message"){super(t,{bubbles:!0,composed:!0,detail:e})}}function O(n){return(e,...t)=>e.dispatchEvent(new N(t,n))}class ${attach(e){e.addEventListener(this._eventType,t=>{t.stopPropagation();const o=t.detail;this.consume(o)})}constructor(e,t,o="service:message"){this._context=t,this._update=e,this._eventType=o}apply(e){this._context.apply(e)}consume(e){this._update(e,this.apply.bind(this),this._context.value)}}function p(n){return n}function m(n){return e=>({...e,...n})}const g="mu:auth:jwt",l=class w extends ${constructor(e){super(P,e,w.EVENT_TYPE)}};l.EVENT_TYPE="auth:message",l.dispatch=O(l.EVENT_TYPE);let v=l;const P=(n,e)=>{switch(n[0]){case"auth/signin":I(n[1]).then(e);return;case"auth/signup":A(n[1]).then(e);return;case"auth/signout":e(U());return;default:const t=n[0];throw new Error(`Unhandled Auth message "${t}"`)}};class k extends _{constructor(){super({user:new a}),new v(this.context).attach(this)}}class a{constructor(){this.authenticated=!1,this.username="anonymous"}static deauthenticate(e){return e.authenticated=!1,e.username="anonymous",localStorage.removeItem(g),e}}class u extends a{constructor(e){super();const t=x(e);console.log("Token payload",t),this.token=e,this.authenticated=!0,this.username=t.username}static authenticate(e){const t=new u(e);return localStorage.setItem(g,e),t}static authenticateFromLocalStorage(){const e=localStorage.getItem(g);return e?u.authenticate(e):new a}}function I(n){const e=window.location.origin;return fetch(`${e}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(t=>{if(t.status===200)return t.json()}).then(t=>{if(t){console.log("Authentication:",t.token);const o=u.authenticate(t.token),s=o?t.token:"";return console.log("Providing auth user:",o),m({user:o,token:s})}else return p})}function A(n){const e=window.location.origin;return fetch(`${e}/signup`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then(t=>{if(t.status===200)return t.json()}).then(t=>(console.log("Registration:",t),p))}function U(){return m({user:new a,token:""})}function j(n){Object.entries(n).map(([e,t])=>customElements.define(e,t))}r.APIUser=a,r.AuthElement=k,r.AuthService=v,r.AuthenticatedUser=u,r.define=j,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
