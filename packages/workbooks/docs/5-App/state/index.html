<!DOCTYPE html>
<html>
<head>
<title>State Management</title>
<script type="importmap">
{ "imports": {"@cre.ative/kram-11ty/runtime":"/modules/@cre.ative/kram-11ty/runtime.mjs","@cre.ative/kram-11ty/styles":"/modules/@cre.ative/kram-11ty/styles.css"} }
</script>
<link rel="stylesheet" href="/modules/@cre.ative/kram-11ty/styles.css">
<script type="module">
import {init, register} from "@cre.ative/kram-11ty/runtime";
init({"count":10});
import("./templates.html.js")
          .then((mod) => register(mod, "undefined", "html", (resource, container) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(resource.default, 'text/html');
            const body = doc.body;
            for ( let def = body.firstElementChild; def; def=body.firstElementChild ) {
              container.appendChild(def); }
          }))
import("./scenes.html.js")
          .then((mod) => register(mod, "undefined", "html", (resource, container) => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(resource.default, 'text/html');
            const body = doc.body;
            const scenes = Object.fromEntries(
              Array.prototype.map.call(body.children, (node) => [
              node && node.dataset.scene, node ])
              .filter(([num]) => Boolean(num)));
            return function render (n, container) {
              const scene = scenes[n]
              if( scene ) {
                for( let child = scene.firstElementChild; child; child = scene.firstElementChild ) {
                  if ( child.tagName === 'SCRIPT' ) {
                    const text = child.firstChild
                    scene.removeChild(child)
                    child = document.createElement('script')
                    child.appendChild(text)
                  } 
                  container.appendChild(child) 
                }
              } 
            }
          }))
import("./module.js")
          .then((mod) => register(mod, "Kram_6365ca69_state", "js", function(resource, container, initial) {
      if ( typeof (resource && resource.mount) === 'function' ) {
        return resource.mount(container, initial)
      }}))
</script>
</head>
<body>
<kram-main>
<h1 slot="title">State Management</h1>
<kram-toc slot="nav"><ol>
<li data-idref="scene-1">State Management</li>
<li data-idref="scene-2">Creating an Observable Model</li>
<li data-idref="scene-3">A Slightly More Complex Model</li>
<li data-idref="scene-4">Creating an Observer</li>
<li data-idref="scene-5">Implementing Observable with Proxy</li>
<li data-idref="scene-6">Appendix</li>
</ol></kram-toc>
<kram-flow><kram-scene 
        scene="1" 
        language="html" 
        ><kram-code slot="scenecode" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>Guest Info<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>travelers-form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>travelers<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span><br>      Number of guests<br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>number<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>travelers-form</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>Travel Dates<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schedule-form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schedule<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span><br>      Check-in on<br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>date<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>first-date<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span><br>      Check-out on<br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>date<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>last-date<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schedule-form</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token punctuation">/></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>Invoice<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>invoice-observer</span> <span class="token attr-name">travelers</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#travelers<span class="token punctuation">"</span></span> <span class="token attr-name">schedule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#schedule<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>invoice-observer</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span></code></pre></kram-code><h1 slot="title">State Management</h1>

<p>Dynamic web pages retrieves data (for example, from an API)
and inserts it into the HTML or DOM.
Originally, the code which rendered data as HTML ran on the server.
Doing so, however, meant that the entire page had to be
reloaded whenever any of the data changes.</p>

<p>To avoid that, developers started using Web APIs
which allow HTML or data to be loaded from the server,
after the page had been completely loaded and rendered.
The first of these APIs was called <code data-mark-around="`">XMLHTTPRequest</code>,
and this technique was often called AJAX, for Asynchronous Javascript and XML.
(At the time, XML was widely used for data APIs,
and XHTML, which cast HTML as strict XML, was promoted as a standard dialect.)</p>

<p>That data may have been formatted server-side as an HTML fragment,
which was simple to splice into the DOM.
But loading the data pre-formatted limited how the data could be used
and the extent to which the user could customize the presentation.
The next development was to serve raw data to the client,
which would use Javascript APIs to build the DOM dynamically.
Web applications written in this way came to be known as <em data-mark-around="_">Web 2.0</em> to
distinguish them from the earlier static or on-demand
server-generated HTML pages.</p>

<p>When a web application loads data from the server,
it is making a local copy of that data.
This copy becomes part of the application&rsquo;s <em data-mark-around="_">state</em>.
Any processing performed client-side is based on that state.
Each time that part of the state is presented in a UI,
it is again copied and converted to digits or some other format.
As the state is passed to different parts of the UI,
many copies are created, resulting in <em data-mark-around="_">local state</em>.
Some of these copies may be <em data-mark-around="_">mutable</em>, meaning that they can be changed,
often in response to some user interaction.
Additionally, new values may be computed which depend on the state and
would be invalid if the state changes.</p>

<p>This is known as the Application State Management problem.
As state proliferates throughout an application,
it becomes unclear which copy of the data should be trusted.
Or, more colloquially, &ldquo;Who owns the data?&rdquo;.</p>

<p>Once we decide who owns the data,
we must ensure that all copies of the data are updated
whenever one of them is modified.
This is an example of the Cache Coherency problem,
often cited as one of the
most difficult problems in Computer Science,
right up there with &ldquo;Naming Things&rdquo;.</p>

<p>Multiple abstractions have been developed for solving this problem,
including Publisher-Subscriber, Immutable Data, and Observer patterns.
Though all are used in various web development frameworks,
we will focus on the Observer pattern, because it can be supported natively
in Javascript through the use of Proxy objects.</p>

<p>In this example, there are two forms which accept input from the user,
and an invoice, the specifics of which depend on the input values.
We&rsquo;ve chosen to have each form manage the data that it collects,
while the invoice will observe those values, and update itself
whenever they change.</p>

<kram-code data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">ObservableElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"open"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><br>      template<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>_model <span class="token operator">=</span> <span class="token function">createObservable</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">get</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_model<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> prop<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">attach</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"observable:change"</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> listener<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">detach</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"observable:change"</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></kram-code></kram-scene>
<kram-scene 
        scene="2" 
        language="html" 
        ><kram-code slot="scenecode" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>travelers-form</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span> Number of guests <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>number<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>travelers-form</span><span class="token punctuation">></span></span></code></pre></kram-code><h2>Creating an Observable Model</h2>

<p>Let&rsquo;s start by looking at the first form.
The traveler details has just one input, for the number of travelers.
So the model for this component contains just a single number,
which we&rsquo;ll call <code data-mark-around="`">count</code>.</p>

<p>We keep the <code data-mark-around="`">&lt;input&gt;</code> value in sync with the model by initializing
the input&rsquo;s value in <code data-mark-around="`">connectedCallback</code> and providing an event
handler for <code data-mark-around="`">onchange</code> events bubbling up from the input.
The event handler is very simple.
There is only one input to generate <code data-mark-around="`">onchange</code> events, so
we just need to set <code data-mark-around="`">count</code> to the target&rsquo;s <code data-mark-around="`">value</code> property.</p>

<p>To make this component&rsquo;s model observable from other components,
we add a <code data-mark-around="`">get model()</code> method.
Notice however that this method does not directly return <code data-mark-around="`">this._model</code>,
but rather <code data-mark-around="`">this._observable</code>, which we initialize by
calling <code data-mark-around="`">createObservable</code> in the constructor.
We will look at this function in detail later,
but for now we can think of <code data-mark-around="`">this._observable</code> as a wrapper
which allows us to update all observers of the model
whenever the <code data-mark-around="`">count</code> property is changed.</p>

<kram-code data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Travelers</span> <span class="token keyword">extends</span> <span class="token class-name">ObservableElement</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">super</span><span class="token punctuation">(</span>Travelers<span class="token punctuation">.</span>html_template<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>onchange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> countInput <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>countInput<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      countInput<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>count<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">static</span> html_template <span class="token operator">=</span> template<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;form><br>    &lt;slot>&lt;/slot><br>  &lt;/form></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"travelers-form"</span><span class="token punctuation">,</span> Travelers<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></kram-code></kram-scene>
<kram-scene 
        scene="3" 
        language="html" 
        ><kram-code slot="scenecode" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schedule-form</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span><br>    Check-in on<br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>date<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>first-date<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span><br>    Check-out on<br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>date<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>last-date<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schedule-form</span><span class="token punctuation">></span></span></code></pre></kram-code><h2>A Slightly More Complex Model</h2>

<p>The second form is more complicated because it has two inputs,
and the model maintains two values, which are dates.
The value of an <code data-mark-around="`">&lt;input type=&quot;date&quot;&gt;</code> is a string in ISO 8601 format, i.e.,
of the form <code data-mark-around="`">YYYY-MM-DD</code>, and we&rsquo;ll use that format for the model, too.
We also provide some utility functions to convert these strings to
Javascript <code data-mark-around="`">Date</code> objects, or to calculate the number of days
and nights in the range, so that observer components don&rsquo;t need
to implement those operations themselves.</p>

<p>In the constructor, the model is initialized and an
observable is created, which is what we expose via the <code data-mark-around="`">get model()</code> method.
The <code data-mark-around="`">value</code> property of each input is initialized to the
corresponding model property in <code data-mark-around="`">connectedCallback</code>.
We also bind an event handler to capture <code data-mark-around="`">onchange</code> events bubbling up
from the two inputs.</p>

<p>Because this form contains more than one input,
<code data-mark-around="`">handleChange</code> must first determine which input was changed
before it can update the appropriate property of the model.
We reference the <code data-mark-around="`">name</code> attribute of the event target for this
purpose.</p>

<kram-code data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Schedule</span> <span class="token keyword">extends</span> <span class="token class-name">ObservableElement</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">super</span><span class="token punctuation">(</span>Schedule<span class="token punctuation">.</span>html_template<span class="token punctuation">,</span> Schedule<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>onchange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">static</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> duration <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> firstDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> lastDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><br>      firstDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> duration <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>msPerDay<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token punctuation">{</span><br>      <span class="token literal-property property">first</span><span class="token operator">:</span> firstDate<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">last</span><span class="token operator">:</span> lastDate<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> firstInput <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><br>      <span class="token string">'input[name="first-date"]'</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> lastInput <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><br>      <span class="token string">'input[name="last-date"]'</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstInput<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      firstInput<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>first<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastInput<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      lastInput<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>last<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">case</span> <span class="token string">"first-date"</span><span class="token operator">:</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>first <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>      <span class="token keyword">case</span> <span class="token string">"last-date"</span><span class="token operator">:</span><br>        <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>last <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">static</span> <span class="token function">firstDate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> first <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">static</span> <span class="token function">lastDate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> last <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">static</span> <span class="token function">days</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> first<span class="token punctuation">,</span> last <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">daysBetween</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> last<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">static</span> <span class="token function">nights</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> first<span class="token punctuation">,</span> last <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">daysBetween</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> last<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">static</span> <span class="token function">daysBetween</span><span class="token punctuation">(</span><span class="token parameter">first<span class="token punctuation">,</span> last</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> firstDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> lastDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><br>      <span class="token punctuation">(</span>lastDate <span class="token operator">-</span> firstDate<span class="token punctuation">)</span> <span class="token operator">/</span> Schedule<span class="token punctuation">.</span>msPerDay<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">static</span> msPerDay <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">static</span> html_template <span class="token operator">=</span> template<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;form><br>    &lt;slot>&lt;/slot><br>  &lt;/form></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"schedule-form"</span><span class="token punctuation">,</span> Schedule<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></kram-code></kram-scene>
<kram-scene 
        scene="4" 
        language="html" 
        ><kram-code slot="scenecode" data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>travelers-form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>travelers<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>travelers-form</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schedule-form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schedule<span class="token punctuation">"</span></span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schedule-form</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>invoice-observer</span> <span class="token attr-name">travelers</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#travelers<span class="token punctuation">"</span></span> <span class="token attr-name">schedule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#schedule<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>invoice-observer</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">></span></span></code></pre></kram-code><h2>Creating an Observer</h2>

<p>The invoice view has its own model,
which supplies the data required to render the invoice.
Some of the values in this model, such as the room rate,
are managed by the component itself.
But the other values depend on the data which is observable in the
form components we just created.
Whenever those values change, we want the invoice to be updated.
Therefore, our <code data-mark-around="`">Invoice</code> component needs to be an <em data-mark-around="_">observer</em> of
both <code data-mark-around="`">Travelers</code> and <code data-mark-around="`">Schedule</code>.</p>

<p>The constructor for <code data-mark-around="`">Invoice</code> are similar to what we did for <code data-mark-around="`">Travelers</code> and <code data-mark-around="`">Schedule</code>.
We create a <code data-mark-around="`">model</code> and initialize it.
This model does not need to be observable outside of the <code data-mark-around="`">Invoice</code> class,
so we don&rsquo;t need to create <code data-mark-around="`">this._observable</code> and we don&rsquo;t need the <code data-mark-around="`">get model()</code> method.
Nothing inside this component accepts user input, so there is no need for an <code data-mark-around="`">onchange</code>
handler.</p>

<p>Similarly, <code data-mark-around="`">connectedCallback</code> starts off by rendering the room rate data from the <code data-mark-around="`">model</code>
into the correct location in the <code data-mark-around="`">Invoice</code>&rsquo;s shadow DOM.
We can use an <code data-mark-around="`">id</code> for this without worrying about conflicts with the light DOM.
Next, we need to render the other data from our model.</p>

<p>But the number of rooms depends on how many guests the user has entered;
the length of stay depends on the users&rsquo; travel schedule;
and the total depends on the number of rooms, length of stay, and the room rate.
We need to observe the <code data-mark-around="`">Travelers</code> and <code data-mark-around="`">Schedule</code> component models,
and update the <code data-mark-around="`">Invoice</code> model before we can render the shadow DOM.
At the same time that we observe those values,
we will also arrange to update the model and DOM on any future changes.
That is what the <code data-mark-around="`">observe</code> method does,
in concert with the observable models created above.</p>

<p>Our application could potentially have multiple instances of <code data-mark-around="`">Travelers</code> or <code data-mark-around="`">Schedule</code>.
So the first step is to tell the <code data-mark-around="`">Invoice</code> component how to find the observable components.
Rather than hard-wire an <code data-mark-around="`">id</code> into the <code data-mark-around="`">class</code>,
we will pass CSS selector strings into <code data-mark-around="`">invoice-observer</code>
as attribute values and have <code data-mark-around="`">observe</code> use those selectors to locate the observable components.</p>

<p>At this point, we can get the current value of the property we want by indexing
into the component&rsquo;s <code data-mark-around="`">model</code>.
But before we return from <code data-mark-around="`">observe</code>,
we want to make sure that this component gets updated every time
the observed value changes.</p>

<p>The <code data-mark-around="`">observe</code> method is generic.
We could factor it out into a base class to make it easier
to create observer components.
We can&rsquo;t expect <code data-mark-around="`">observe</code> to be able to make the appropriate updates to the model and DOM
for whatever future changes may occur.
Instead, whenever we call <code data-mark-around="`">observe</code>,
and want it to react to future changes in the observed values,
we will also pass a callback function,
which will perform the update.</p>

<p>If a callback function is provided when calling <code data-mark-around="`">observe</code>,
it will be called whenever the value is observed,
being passed the latest observed value.
The first call occurs on the first observation,
before returning from <code data-mark-around="`">observe</code>.
In addition, we can set up an event handler for
<code data-mark-around="`">observable:change</code> events dispatched on the observable component.</p>

<kram-code data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">observable<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>_observable <span class="token operator">=</span> observable<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>_accessor <span class="token operator">=</span> prop<br>      <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token operator">=></span> model<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><br>      <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token operator">=></span> model<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>_listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_accessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_observable<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">thenUpdate</span><span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>_listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>_observable<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> ev<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>_listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>      observable<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></kram-code>
<kram-code data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">ObserverElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>model <span class="token operator">=</span> model<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"open"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><br>      template<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>_observers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">disconnectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>_observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obs</span><span class="token punctuation">)</span> <span class="token operator">=></span> obs<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">observable<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> observer <span class="token operator">=</span> observable<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>_observers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> observer<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre></kram-code>
<kram-code data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Invoice</span> <span class="token keyword">extends</span> <span class="token class-name">ObserverElement</span> <span class="token punctuation">{</span><br>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">super</span><span class="token punctuation">(</span>Invoice<span class="token punctuation">.</span>html_template<span class="token punctuation">,</span> Invoice<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">static</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token punctuation">{</span><br>      <span class="token literal-property property">rate</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">currency</span><span class="token operator">:</span> <span class="token string">"€"</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">rooms</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>      <span class="token literal-property property">nights</span><span class="token operator">:</span> <span class="token number">7</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> rateSpan <span class="token operator">=</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"room-rate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    rateSpan<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>rate<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>currency<br>    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getObservable</span><span class="token punctuation">(</span><span class="token string">"travelers"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token string">"count"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateGuests</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getObservable</span><span class="token punctuation">(</span><span class="token string">"schedule"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenUpdate</span><span class="token punctuation">(</span><br>      <span class="token punctuation">(</span><span class="token parameter">schedule</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateNights</span><span class="token punctuation">(</span>Schedule<span class="token punctuation">.</span><span class="token function">nights</span><span class="token punctuation">(</span>schedule<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">getObservable</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> selector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">updateGuests</span><span class="token punctuation">(</span><span class="token parameter">guests</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> rooms <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>guests <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> roomSpan <span class="token operator">=</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"room-count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    roomSpan<span class="token punctuation">.</span>textContent <span class="token operator">=</span> rooms<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>rooms <span class="token operator">=</span> rooms<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">updateNights</span><span class="token punctuation">(</span><span class="token parameter">nights</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> nightSpan <span class="token operator">=</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"night-count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    nightSpan<span class="token punctuation">.</span>textContent <span class="token operator">=</span> nights<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>nights <span class="token operator">=</span> nights<span class="token punctuation">;</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">updateTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> totalSpan <span class="token operator">=</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"total-charge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> total <span class="token operator">=</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>rate <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>rooms <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>nights<span class="token punctuation">;</span><br>    totalSpan<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>total<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>currency<br>    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">static</span> html_template <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><br>    <span class="token string">"invoice-template"</span><br>  <span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"invoice-observer"</span><span class="token punctuation">,</span> Invoice<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></kram-code>
<kram-code data-language="html"><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>invoice-template<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dl</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">></span></span>Room Rate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>room-rate<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>199 USD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">></span></span>#Rooms<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>room-count<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">></span></span>#Nights<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>night-count<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dt</span><span class="token punctuation">></span></span>Total<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dt</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dd</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>total-charge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>1393 USD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dd</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dl</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><br>    <span class="token selector">dl</span> <span class="token punctuation">{</span><br>      <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span><br>      <span class="token property">width</span><span class="token punctuation">:</span> max-content<span class="token punctuation">;</span><br>      <span class="token property">gap</span><span class="token punctuation">:</span> 1rem<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token selector">dl > div</span> <span class="token punctuation">{</span><br>      <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span><br>      <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span><br>      <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token selector">dt</span> <span class="token punctuation">{</span><br>      <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token selector">dd</span> <span class="token punctuation">{</span><br>      <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span></code></pre></kram-code></kram-scene>
<kram-scene 
        scene="5" 
        language="null" 
        norender><h2>Implementing Observable with Proxy</h2>

<kram-code data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createObservable</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> eventTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token constant">OBSERVABLE_CHANGE_EVENT</span> <span class="token operator">=</span> <span class="token string">"observable:change"</span><span class="token punctuation">;</span><br><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"creating Observable:"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token operator">===</span> <span class="token string">"then"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">const</span> value <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Observable['</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prop<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'] => </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span> value<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">const</span> oldValue <span class="token operator">=</span> root<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Observable['</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prop<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'] &lt;= </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><br>          newValue<br>        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; was </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">const</span> didSet <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><br>        target<span class="token punctuation">,</span><br>        prop<span class="token punctuation">,</span><br>        newValue<span class="token punctuation">,</span><br>        receiver<br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>didSet<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">let</span> evt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomEvent</span><span class="token punctuation">(</span><span class="token constant">OBSERVABLE_CHANGE_EVENT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>          <span class="token literal-property property">bubbles</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><br>          <span class="token literal-property property">cancelable</span><span class="token operator">:</span> <span class="token boolean">true</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>evt<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>          <span class="token literal-property property">property</span><span class="token operator">:</span> prop<span class="token punctuation">,</span><br>          oldValue<span class="token punctuation">,</span><br>          <span class="token literal-property property">value</span><span class="token operator">:</span> newValue<br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        eventTarget<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>          <span class="token string">"dispatched event to target"</span><span class="token punctuation">,</span><br>          evt<span class="token punctuation">,</span><br>          eventTarget<br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><br>          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Observable['</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prop<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] was not set to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">return</span> didSet<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> proxy<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></kram-code></kram-scene>
<kram-scene 
        scene="6" 
        language="null" 
        norender><h2>Appendix</h2>

<p>Helper function for creating templates from Javascript:</p>

<kram-code data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token parameter">strings<span class="token punctuation">,</span> <span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> html <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span><br>    i <span class="token operator">?</span> <span class="token punctuation">[</span>values<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span>s<span class="token punctuation">]</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">let</span> tpl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"template"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  tpl<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> html<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> tpl<span class="token punctuation">.</span>content<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre></kram-code></kram-scene></kram-flow>
</kram-main>
</body>
</html>
