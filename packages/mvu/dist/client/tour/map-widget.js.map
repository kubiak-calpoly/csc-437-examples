{
  "version": 3,
  "sources": ["../../../src/client/tour/map-widget.ts"],
  "sourcesContent": ["import { css, html, svg, LitElement } from \"lit\";\nimport {\n  customElement,\n  state,\n  property\n} from \"lit/decorators.js\";\nimport { createContext, consume, provide } from \"@lit/context\";\nimport {\n  geoEquirectangular,\n  geoPath\n} from \"https://cdn.jsdelivr.net/npm/d3-geo@3/+esm\";\nimport { Point } from \"../../../models/Geo.ts\";\nimport { reset, elements } from \"../shared/css-base\";\n\ntype ProjectionFn = (Point) => { x: number; y: number };\n\nclass MapProjection {\n  _projection: ProjectionFn = (_) => ({\n    x: 0,\n    y: 0\n  });\n\n  constructor(fn: ProjectionFn) {\n    this._projection = fn || ((_) => ({ x: 0, y: 0 }));\n  }\n\n  project(pt: Point) {\n    return this._projection(pt);\n  }\n}\n\nconst mapContext = createContext<MapProjection>(\n  Symbol(\"mapProjection\")\n);\n\n@customElement(\"map-widget\")\nexport class MapWidget extends LitElement {\n  _viewBox = [\n    [0, 0],\n    [1000, 1000]\n  ];\n\n  @property()\n  src: string = \"\";\n\n  @state()\n  _mapSvg = svg`\n      <g class=\"basemap\">\n      </g>\n    `;\n\n  @state()\n  _geoGenerator = undefined;\n\n  @provide({ context: mapProjection })\n  projection = new MapProjection();\n\n  render() {\n    return html`\n      <section>\n        <h2>Map</h2>\n        <div class=\"overlay\">\n          <svg viewBox=\"0 0 1000 1000\" id=\"map-area\">\n            ${this._mapSvg}\n          </svg>\n          <div id=\"markers\">\n            <slot></slot>\n          </div>\n        </div>\n      </section>\n    `;\n  }\n\n  static styles = [\n    reset,\n    elements,\n    css`\n      :host {\n        padding: 0 var(--size-spacing-medium);\n      }\n      .overlay {\n        width: 100%;\n        aspect-ratio: 1;\n        position: relative;\n      }\n      .overlay > * {\n        position: absolute;\n        left: 0;\n        right: 0;\n        top: 0;\n        bottom: 0;\n      }\n      svg#map-area {\n        fill: none;\n        stroke: var(--color-accent);\n        stroke-width: 5px;\n      }\n    `\n  ];\n\n  connectedCallback() {\n    const src = this.getAttribute(\"src\");\n    super.connectedCallback();\n\n    if (src) {\n      this._fetchData(src);\n    }\n  }\n\n  attributeChangedCallback(name, oldValue, newValue) {\n    super.attributeChangedCallback(name, oldValue, newValue);\n    if (name === \"src\") {\n      if (oldValue) {\n        this._clearData();\n      }\n      if (newValue && oldValue !== null) {\n        this._fetchData(newValue);\n      }\n    }\n  }\n\n  _fetchData(src) {\n    fetch(src)\n      .then((response) => {\n        if (response.status === 200) {\n          return response.json();\n        }\n        return null;\n      })\n      .then((geojson) => {\n        this._updateGeoGenerator(geojson);\n        this._mapSvg = this._renderMap(geojson);\n        this._positionContents();\n      });\n  }\n\n  _updateGeoGenerator(geojson) {\n    const base = geoEquirectangular();\n    const projection = geojson\n      ? base.fitExtent(this._viewBox, geojson)\n      : base;\n    this._geoGenerator = geoPath().projection(projection);\n  }\n\n  _renderMap(geojson) {\n    const { features } = geojson;\n    const paths = features.map(this._geoGenerator);\n\n    return svg`\n    <g class=\"basemap\">\n      ${paths.map((p) => svg`<path d=${p} />`)}\n    </g>\n    `;\n  }\n\n  _positionContents() {\n    const mapArea = this.shadowRoot.getElementById(\"map-area\");\n    const markers = Array.from(this.children);\n    const { width } = mapArea.getBoundingClientRect();\n    const scale = width / this._viewBox[1][1];\n\n    const projectionFn = (pt: Point) => {\n      const { lat, lon } = pt;\n      console.log(\"Scaling marker:\", text, lat, lon);\n      if (lat && lon) {\n        const feature = {\n          type: \"Feature\",\n          properties: { name: \"marker\" },\n          geometry: {\n            type: \"Point\",\n            coordinates: [lon, lat]\n          }\n        };\n        const path = this._geoGenerator(feature);\n        const matches = path.match(/M([.0-9-]+),([.0-9-]+)/);\n        if (matches) {\n          const [_, x, y] = matches;\n          console.log(\"Positioning marker to\", x, y);\n          return {\n            x: scale * parseFloat(x),\n            y: scale * parseFloat(y)\n          };\n        }\n      }\n\n      return { x: 0, y: 0 };\n    };\n\n    this.projection = new MapProjection(projectionFn);\n  }\n}\n\n@customElement(\"map-marker\")\nexport class MapMarker extends LitElement {\n  @property()\n  lat = 0;\n\n  @property()\n  lon = 0;\n\n  @consume({ context: mapProjection })\n  rs;\n  projection = new MapProjection();\n\n  render() {\n    const pt = this as Point;\n    const { x, y } = this.projection.project(pt);\n    const icon = svg`\n    <use href=\"/icons/markers.svg#icon-poi\" />\n    `;\n\n    return html`\n      <i style=\"transform: translate(${x}px,${y}px)\">\n        <svg class=\"icon\">${icon}</svg>\n        <label><slot></slot></label>\n      </i>\n    `;\n  }\n\n  static styles = css`\n    :host {\n      position: absolute;\n      bottom: 100%;\n      left: -1rem;\n      --transform-marker: scale(1);\n    }\n    :host([selected]) {\n      --transform-marker: scale(1.5);\n    }\n    i {\n      display: inline-block;\n    }\n    i:hover {\n      --transform-marker: scale(1.5);\n    }\n    svg.icon {\n      display: inline;\n      height: 2rem;\n      width: 2rem;\n      vertical-align: bottom;\n      fill: var(--color-accent);\n      transform-origin: bottom center;\n      transition: transform 0.5s;\n      transform: var(--transform-marker);\n    }\n    label {\n      margin-left: -0.5em;\n    }\n  `;\n}\n"],
  "mappings": "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",
  "names": []
}
